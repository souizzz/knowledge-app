# 🧪 メール認証機能テストガイド

## 📋 テスト概要

このガイドでは、Resend + Supabaseのメール認証機能を包括的にテストする方法を説明します。

## 🚀 テストの実行

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

```bash
# .env.local ファイルを作成
cp env.local.example .env.local

# 実際の値を設定
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
TEST_EMAIL=your-test-email@example.com
NEXT_PUBLIC_FRONTEND_URL=http://localhost:3000
```

### 3. 自動テストの実行

```bash
# メール認証機能のテスト
npm run test:email-auth

# 全テストの実行
npm run test:all
```

## 🔍 テスト項目

### 1. Supabase接続テスト
- データベース接続の確認
- 認証サービスの動作確認

### 2. メールアドレス検証テスト
- 有効なメールアドレスの検証
- 無効なメールアドレスの検証
- 空文字の検証

### 3. Magic Link生成テスト
- OTP生成の確認
- メール送信の確認
- リダイレクトURLの確認

### 4. ユーザー作成テスト
- 新規ユーザー作成の確認
- 既存ユーザーの処理確認

### 5. セッション管理テスト
- セッション取得の確認
- セッション有効性の確認

### 6. エラーハンドリングテスト
- 無効なメールアドレスでのエラー処理
- 空のメールアドレスでのエラー処理
- ネットワークエラーの処理

### 7. レート制限テスト
- 複数リクエストの処理
- レート制限の確認

### 8. フロントエンド統合テスト
- ログインページのアクセス確認
- フォームの存在確認

### 9. データベーススキーマテスト
- 必要なテーブルの存在確認
- スキーマの整合性確認

## 🖥️ 手動テスト

### 1. 開発環境でのテスト

```bash
# フロントエンドを起動
npm run dev

# ブラウザでアクセス
# http://localhost:3000/login
```

#### テスト手順
1. **ログインページにアクセス**
2. **有効なメールアドレスを入力**
3. **「メールリンクを送る」をクリック**
4. **メールボックスを確認**
5. **メールのリンクをクリック**
6. **認証が完了することを確認**

### 2. エラーケースのテスト

#### 無効なメールアドレス
- `invalid-email` を入力
- エラーメッセージが表示されることを確認

#### 空のメールアドレス
- 何も入力せずに送信
- エラーメッセージが表示されることを確認

#### ネットワークエラー
- インターネット接続を切断
- エラーメッセージが表示されることを確認

### 3. UI/UXテスト

#### ローディング状態
- 送信ボタンをクリック
- ローディングアニメーションが表示されることを確認

#### 成功メッセージ
- メール送信成功後
- 成功メッセージが表示されることを確認

#### エラーメッセージ
- エラー発生時
- 適切なエラーメッセージが表示されることを確認

## 📊 テスト結果の解釈

### 成功パターン
```
✅ Supabase接続: 接続成功
✅ メール検証: valid@example.com: 有効
✅ Magic Link生成: Magic Linkが正常に生成されました
✅ 新規ユーザー作成: 新規ユーザーが正常に作成されました
✅ セッション取得: セッションが正常に取得されました
✅ 無効メールアドレス処理: エラーが正常に検出されました
✅ 空メールアドレス処理: エラーが正常に検出されました
✅ レート制限: 0個のリクエストでエラーが発生
✅ ログインページアクセス: ページが正常にアクセスできました
✅ ログインフォーム存在: ログインフォームが存在します
✅ organizations テーブル: テーブルが存在します
✅ org_members テーブル: テーブルが存在します
✅ invites テーブル: テーブルが存在します

📊 テスト結果サマリー:
✅ 成功: 13
❌ 失敗: 0
📈 成功率: 100.0%

🎉 テスト完了！
🎊 すべてのテストが成功しました！
```

### 失敗パターン
```
❌ Supabase接続: invalid API key
❌ Magic Link生成: SMTP not configured

📊 テスト結果サマリー:
✅ 成功: 11
❌ 失敗: 2
📈 成功率: 84.6%

❌ 失敗したテスト:
   - Supabase接続: invalid API key
   - Magic Link生成: SMTP not configured

⚠️  一部のテストが失敗しました。設定を確認してください。
```

## 🚨 トラブルシューティング

### よくある問題と解決方法

#### Supabase接続エラー
1. **APIキーを確認**
2. **プロジェクトURLを確認**
3. **ネットワーク接続を確認**

#### Magic Link生成エラー
1. **SMTP設定を確認**
2. **Resend APIキーを確認**
3. **メールテンプレートを確認**

#### フロントエンドアクセスエラー
1. **フロントエンドが起動しているか確認**
2. **ポート番号を確認**
3. **ファイアウォール設定を確認**

#### データベーススキーマエラー
1. **マイグレーションを実行**
2. **テーブルが存在するか確認**
3. **権限設定を確認**

## 📈 パフォーマンステスト

### 1. レスポンス時間テスト
- メール送信の応答時間
- 認証完了の応答時間
- ページ読み込み時間

### 2. 負荷テスト
- 同時接続数のテスト
- メール送信の負荷テスト
- データベースの負荷テスト

### 3. 可用性テスト
- 長時間の動作確認
- メモリリークの確認
- エラーハンドリングの確認

## 🔒 セキュリティテスト

### 1. 認証セキュリティ
- トークンの有効期限
- ワンタイム使用
- セッション管理
- CSRF保護

### 2. メールセキュリティ
- スパム対策
- フィッシング対策
- 暗号化

### 3. データ保護
- 個人情報の保護
- ログの適切な管理
- アクセス制御

## ✅ テスト完了チェックリスト

### 基本機能
- [ ] ログイン機能が正常に動作
- [ ] メール送信が正常に動作
- [ ] 認証フローが正常に動作
- [ ] エラーハンドリングが正常に動作

### UI/UX
- [ ] ローディング状態が適切に表示
- [ ] エラーメッセージが適切に表示
- [ ] 成功メッセージが適切に表示
- [ ] レスポンシブデザインが動作

### セキュリティ
- [ ] トークンの有効期限が適切
- [ ] セッション管理が適切
- [ ] CSRF保護が動作
- [ ] レート制限が動作

### パフォーマンス
- [ ] レスポンス時間が適切
- [ ] 負荷テストが成功
- [ ] 可用性テストが成功

これで包括的なテストが完了し、本番環境での安定した動作が保証されます！
